<!doctype html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FX –ö–∞–ª–∫—É–ª–∞—Ç–æ—Ä</title>

  <style>
    :root{
      --bg:#0b0f18;
      --panel:#0f1626;
      --panel2:#111b30;
      --text:#eaf0ff;
      --muted:#a9b6d8;
      --line:#223154;
      --accent:#7aa2ff;
      --good:#35d07f;
      --warn:#ffcc66;
      --bad:#ff6b6b;
      --btn:#172244;
      --btn2:#1b2a54;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1000px 600px at 20% -10%, rgba(122,162,255,.25), transparent 60%),
                  radial-gradient(900px 600px at 100% 10%, rgba(53,208,127,.12), transparent 55%),
                  var(--bg);
      color:var(--text);
      padding:22px 14px 60px;
    }
    .wrap{max-width:980px;margin:0 auto}
    .header{
      display:flex;gap:12px;align-items:center;justify-content:space-between;
      margin-bottom:14px;
    }
    .title{
      display:flex;flex-direction:column;gap:4px;
    }
    .title h1{
      margin:0;
      font-size:22px;
      letter-spacing:.2px;
    }
    .title .sub{
      color:var(--muted);
      font-size:13px;
    }
    .tabs{
      display:flex;gap:8px;flex-wrap:wrap;
      justify-content:flex-end;
    }
    .tab{
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      color:var(--text);
      padding:10px 12px;
      border-radius: 999px;
      cursor:pointer;
      user-select:none;
      font-size:13px;
      transition: transform .06s ease, border-color .2s ease, background .2s ease;
    }
    .tab:hover{transform:translateY(-1px); border-color: rgba(122,162,255,.45)}
    .tab.active{
      background: linear-gradient(180deg, rgba(122,162,255,.22), rgba(122,162,255,.08));
      border-color: rgba(122,162,255,.65);
    }

    .grid{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 940px){
      .grid{grid-template-columns:1fr}
      .tabs{justify-content:flex-start}
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .head{
      padding:14px 16px;
      border-bottom:1px solid rgba(34,49,84,.7);
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      display:flex;gap:10px;align-items:center;justify-content:space-between;
    }
    .card .head .h{
      font-weight:650;
      font-size:14px;
      letter-spacing:.2px;
      display:flex;gap:10px;align-items:center;
    }
    .badge{
      font-size:12px;
      color:var(--muted);
      border:1px solid rgba(34,49,84,.85);
      padding:6px 10px;
      border-radius:999px;
      background: rgba(17,27,48,.55);
    }
    .body{padding:14px 16px}

    .row{display:grid;grid-template-columns: 1fr 1fr; gap:12px}
    @media (max-width: 640px){ .row{grid-template-columns:1fr} }

    label{display:flex;flex-direction:column; gap:8px; font-size:12px; color:var(--muted)}
    input, textarea, select{
      width:100%;
      background: rgba(15,22,38,.8);
      border:1px solid rgba(34,49,84,.9);
      border-radius: 14px;
      padding:11px 12px;
      color:var(--text);
      outline:none;
      font-size:14px;
    }
    input:focus, textarea:focus, select:focus{border-color: rgba(122,162,255,.75)}
    textarea{min-height:80px; resize:vertical}

    .mini{font-size:11px; color:var(--muted)}
    .help{
      color:var(--muted);
      font-size:12px;
      line-height:1.35;
    }

    .controls{
      display:flex;flex-wrap:wrap;gap:8px; align-items:center;
      margin-top:10px;
    }
    .btn{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid rgba(34,49,84,.95);
      color:var(--text);
      padding:9px 12px;
      border-radius: 12px;
      cursor:pointer;
      user-select:none;
      font-size:13px;
      transition: transform .06s ease, border-color .2s ease;
    }
    .btn:hover{transform:translateY(-1px); border-color: rgba(122,162,255,.55)}
    .btn.primary{
      background: linear-gradient(180deg, rgba(122,162,255,.22), rgba(122,162,255,.08));
      border-color: rgba(122,162,255,.65);
    }
    .btn.ghost{
      background: rgba(15,22,38,.55);
    }

    .quick{
      display:flex;flex-wrap:wrap; gap:8px;
      margin-top:10px;
    }
    .qbtn{
      padding:8px 10px;
      border-radius: 999px;
      background: rgba(23,34,68,.65);
      border:1px solid rgba(34,49,84,.95);
      color:var(--text);
      font-size:12px;
      cursor:pointer;
      user-select:none;
      transition: transform .06s ease, border-color .2s ease;
    }
    .qbtn:hover{transform:translateY(-1px); border-color: rgba(122,162,255,.55)}
    .qbtn.active{
      background: rgba(122,162,255,.18);
      border-color: rgba(122,162,255,.65);
    }

    .split{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      margin-top:10px;
    }
    .toggle{
      display:flex; gap:6px; align-items:center;
      background: rgba(17,27,48,.65);
      border:1px solid rgba(34,49,84,.9);
      border-radius: 999px;
      padding:6px;
    }
    .tbtn{
      padding:8px 10px;
      border-radius: 999px;
      font-size:12px;
      cursor:pointer;
      user-select:none;
      color:var(--muted);
    }
    .tbtn.active{
      background: rgba(122,162,255,.18);
      color: var(--text);
      border: 1px solid rgba(122,162,255,.55);
    }

    .results{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-top:12px;
    }
    @media (max-width: 780px){ .results{grid-template-columns:1fr} }

    .kpi{
      background: rgba(17,27,48,.55);
      border:1px solid rgba(34,49,84,.85);
      border-radius: 16px;
      padding:12px 12px;
    }
    .kpi .k{
      display:flex; align-items:baseline; justify-content:space-between;
      gap:10px;
    }
    .kpi .name{
      color:var(--muted);
      font-size:12px;
    }
    .kpi .val{
      font-size:18px;
      font-weight:700;
      letter-spacing:.2px;
    }
    .kpi .sub{
      color:var(--muted);
      font-size:12px;
      margin-top:6px;
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
    }
    .pill{
      padding:4px 8px;
      border-radius: 999px;
      border:1px solid rgba(34,49,84,.85);
      background: rgba(15,22,38,.55);
      font-size:11px;
      color:var(--muted);
    }
    .pill.good{border-color: rgba(53,208,127,.55); color: rgba(53,208,127,.95)}
    .pill.warn{border-color: rgba(255,204,102,.55); color: rgba(255,204,102,.95)}
    .pill.bad{border-color: rgba(255,107,107,.55); color: rgba(255,107,107,.95)}

    .warnbox{
      margin-top:12px;
      padding:12px 12px;
      border-radius: 16px;
      border: 1px dashed rgba(255,204,102,.7);
      background: rgba(255,204,102,.08);
      color: rgba(255,204,102,.95);
      display:none;
    }

    .chartwrap{
      display:grid;
      grid-template-columns: 220px 1fr;
      gap:14px;
      align-items:center;
      margin-top:12px;
    }
    @media (max-width: 640px){ .chartwrap{grid-template-columns:1fr} }
    canvas{width:220px;height:220px}
    .legend{display:flex; flex-direction:column; gap:8px}
    .legrow{display:flex; gap:10px; align-items:center; justify-content:space-between}
    .dot{width:10px;height:10px;border-radius:999px}
    .legname{color:var(--muted); font-size:12px}
    .legval{font-weight:650; font-size:12px}

    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background: rgba(17,27,48,.92);
      border:1px solid rgba(34,49,84,.9);
      color: var(--text);
      padding:10px 12px;
      border-radius: 999px;
      box-shadow: var(--shadow);
      font-size:13px;
      display:none;
      z-index:99;
    }

    .section{display:none}
    .section.active{display:block}

    .smallnote{font-size:11px;color:var(--muted);margin-top:8px}
    .hr{height:1px;background:rgba(34,49,84,.55); margin:14px 0}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="header">
      <div class="title">
        <h1>FX –ö–∞–ª–∫—É–ª–∞—Ç–æ—Ä</h1>
        <div class="sub">BGN‚ÜîEUR ‚Ä¢ –†–µ—Å—Ç–æ ‚Ä¢ –ú–∞—Ä–∂ (–ö–æ–Ω—Å—É–ª—Ç–∞–Ω—Ç–∏) ‚Ä¢ –±–µ–∑/—Å –î–î–° ‚Ä¢ 2 –∑–Ω–∞–∫–∞</div>
      </div>
      <div class="tabs">
        <div class="tab active" data-tab="margin">üìà –ú–∞—Ä–∂</div>
        <div class="tab" data-tab="fx">üí± –ö–æ–Ω–≤–µ—Ä—Ç–æ—Ä</div>
        <div class="tab" data-tab="change">ü™ô –†–µ—Å—Ç–æ</div>
      </div>
    </div>

    <!-- ===================== MAR–ñ ===================== -->
    <section id="tab-margin" class="section active">
      <div class="grid">
        <div class="card">
          <div class="head">
            <div class="h">üìà –ú–∞—Ä–∂ + –ö–æ–Ω—Å—É–ª—Ç–∞–Ω—Ç–∏</div>
            <div class="badge">–ö–ª–∞—Å–∏—á–µ—Å–∫–∏ –º–∞—Ä–∂: –ø–µ—á–∞–ª–±–∞ / –ø—Ä–∏—Ö–æ–¥</div>
          </div>
          <div class="body">

            <div class="row">
              <label>
                –†–∞–∑—Ö–æ–¥ –¥–æ –Ω–∞—Å (–ª–≤.)
                <input id="m_cost" inputmode="decimal" placeholder="–Ω–∞–ø—Ä. 7500" />
              </label>
              <label>
                –ö–æ–Ω—Å—É–ª—Ç–∞–Ω—Ç–∏ (FOC) (–ª–≤.)
                <input id="m_cons" inputmode="decimal" placeholder="–Ω–∞–ø—Ä. 2500" />
              </label>
            </div>

            <div class="row" style="margin-top:12px;">
              <label>
                –î–î–° (%)
                <input id="m_vat" inputmode="decimal" placeholder="20" value="20" />
              </label>
              <label>
                –ë–∞–∑–∞ (–†–∞–∑—Ö–æ–¥ + –ö–æ–Ω—Å—É–ª—Ç–∞–Ω—Ç–∏) (–ª–≤.)
                <input id="m_base" disabled />
              </label>
            </div>

            <div class="hr"></div>

            <div class="row">
              <label>
                –¶–µ–ª–µ–≤–∏ –º–∞—Ä–∂ (%) (0‚Äì1000)
                <input id="m_margin" inputmode="decimal" placeholder="–Ω–∞–ø—Ä. 20.00" />
                <div class="mini">–ú–æ–∂–µ –¥–∞ –ø–∏—à–µ—à —Ä—ä—á–Ω–æ, –¥–∞ –ø–æ–ª–∑–≤–∞—à –ø–ª—ä–∑–≥–∞—á –∏–ª–∏ –±—ä—Ä–∑–∏ –±—É—Ç–æ–Ω–∏.</div>
              </label>

              <label>
                –ü–ª—ä–∑–≥–∞—á (–º–∞—Ä–∂ %)
                <input id="m_slider" type="range" min="0" max="1000" step="0.01" value="20" />
                <div class="mini">–¢–æ—á–Ω–æ—Å—Ç: 0.01%</div>
              </label>
            </div>

            <div class="quick" id="m_quick">
              <!-- 5..50 –ø—Ä–µ–∑ 5 -->
            </div>

            <div class="split">
              <div class="toggle" title="–ò–∑–±–µ—Ä–∏ –∫–∞–∫ —É–ø—Ä–∞–≤–ª—è–≤–∞—à –∏–∑—á–∏—Å–ª–µ–Ω–∏–µ—Ç–æ">
                <div class="tbtn active" id="mode_target_margin">–¶–µ–ª: –ú–∞—Ä–∂ %</div>
                <div class="tbtn" id="mode_target_profit">–¶–µ–ª: –ü–µ—á–∞–ª–±–∞ (–ª–≤.)</div>
              </div>

              <label style="flex:1; min-width:240px; margin:0;">
                –¶–µ–ª–µ–≤–∞ –ø–µ—á–∞–ª–±–∞ –∑–∞ —Ñ–∏—Ä–º–∞—Ç–∞ (–ª–≤.)
                <input id="m_target_profit" inputmode="decimal" placeholder="–Ω–∞–ø—Ä. 2500" />
                <div class="mini">–ê–∫—Ç–∏–≤–Ω–æ —Å–∞–º–æ –ø—Ä–∏ ‚Äû–¶–µ–ª: –ü–µ—á–∞–ª–±–∞ (–ª–≤.)‚Äú.</div>
              </label>
            </div>

            <div class="hr"></div>

            <div class="row">
              <label>
                –¶–µ–Ω–∞ –∫—ä–º –∫–ª–∏–µ–Ω—Ç–∞ (–±–µ–∑ –î–î–°) (–ª–≤.)
                <input id="m_price_ex" inputmode="decimal" placeholder="–Ω–∞–ø—Ä. 12500" />
                <div class="mini">–ê–∫–æ –≤—ä–≤–µ–¥–µ—à —Ü–µ–Ω–∞ ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∏–∑—á–∏—Å–ª—è–≤–∞ –º–∞—Ä–∂ –∏ –ø–µ—á–∞–ª–±–∞.</div>
              </label>

              <label>
                –¶–µ–Ω–∞ –∫—ä–º –∫–ª–∏–µ–Ω—Ç–∞ (—Å –î–î–°) (–ª–≤.)
                <input id="m_price_inc" inputmode="decimal" placeholder="–Ω–∞–ø—Ä. 15000" />
                <div class="mini">–ú–æ–∂–µ –¥–∞ –≤—ä–≤–µ–∂–¥–∞—à –∏ —Ç—É–∫ ‚Üí –∏–∑—á–∏—Å–ª—è–≤–∞ –±–µ–∑ –î–î–° + –º–∞—Ä–∂.</div>
              </label>
            </div>

            <div class="controls">
              <div class="btn ghost" id="btn_recalc">üîÑ –ü—Ä–µ—Å–º–µ—Ç–Ω–∏</div>
              <div class="btn primary" id="btn_copy">üìã Copy summary</div>
            </div>

            <label style="margin-top:12px;">
              –ó–∞–±–µ–ª–µ–∂–∫–∏ (–ø–æ –∏–∑–±–æ—Ä)
              <textarea id="m_notes" placeholder="–Ω–∞–ø—Ä. –¥–æ—Å—Ç–∞–≤–∫–∞ –¥–æ 5 —Ä–∞–±–æ—Ç–Ω–∏ –¥–Ω–∏, –≥–∞—Ä–∞–Ω—Ü–∏—è 24 –º–µ—Å–µ—Ü–∞..."></textarea>
            </label>

            <div class="warnbox" id="m_warn"></div>

            <div class="chartwrap">
              <div style="display:flex; justify-content:center;">
                <canvas id="m_chart" width="220" height="220"></canvas>
              </div>
              <div class="legend" id="m_legend"></div>
            </div>

          </div>
        </div>

        <div class="card">
          <div class="head">
            <div class="h">üìå –†–µ–∑—É–ª—Ç–∞—Ç–∏</div>
            <div class="badge">2 –∑–Ω–∞–∫–∞</div>
          </div>
          <div class="body">

            <div class="results">
              <div class="kpi">
                <div class="k">
                  <div class="name">–ü—Ä–∏—Ö–æ–¥ –æ—Ç –∫–ª–∏–µ–Ω—Ç (–±–µ–∑ –î–î–°)</div>
                  <div class="val" id="r_revenue_ex">0.00 –ª–≤.</div>
                </div>
                <div class="sub">
                  <span class="pill" id="r_vatpill">–î–î–°: 0.00 –ª–≤.</span>
                </div>
              </div>

              <div class="kpi">
                <div class="k">
                  <div class="name">–ü–µ—á–∞–ª–±–∞ –∑–∞ —Ñ–∏—Ä–º–∞—Ç–∞ (–±–µ–∑ –î–î–°)</div>
                  <div class="val" id="r_profit">0.00 –ª–≤.</div>
                </div>
                <div class="sub">
                  <span class="pill good" id="r_marginpill">–ú–∞—Ä–∂: 0.00%</span>
                </div>
              </div>

              <div class="kpi">
                <div class="k">
                  <div class="name">–ö–æ–Ω—Å—É–ª—Ç–∞–Ω—Ç–∏ (FOC)</div>
                  <div class="val" id="r_cons">0.00 –ª–≤.</div>
                </div>
                <div class="sub">
                  <span class="pill" id="r_basepill">–ë–∞–∑–∞: 0.00 –ª–≤.</span>
                </div>
              </div>

              <div class="kpi">
                <div class="k">
                  <div class="name">–û–±—â–æ –∫—ä–º –∫–ª–∏–µ–Ω—Ç <span class="mini">–±–µ–∑ –î–î–°</span></div>
                  <div class="val" id="r_total_ex">0.00 –ª–≤.</div>
                </div>
                <div class="sub">
                  <span class="pill">–û–±—â–æ <span class="mini">—Å –î–î–°</span>: <span id="r_total_inc">0.00 –ª–≤.</span></span>
                </div>
              </div>
            </div>

            <div class="smallnote">
              * ‚Äû–ú–∞—Ä–∂‚Äú = –ü–µ—á–∞–ª–±–∞ / –ü—Ä–∏—Ö–æ–¥ (–±–µ–∑ –î–î–°). ‚Äû–ë–∞–∑–∞‚Äú = –†–∞–∑—Ö–æ–¥ –¥–æ –Ω–∞—Å + –ö–æ–Ω—Å—É–ª—Ç–∞–Ω—Ç–∏.
            </div>

          </div>
        </div>
      </div>
    </section>

    <!-- ===================== FX ===================== -->
    <section id="tab-fx" class="section">
      <div class="grid">
        <div class="card">
          <div class="head">
            <div class="h">üí± –ö–æ–Ω–≤–µ—Ä—Ç–æ—Ä BGN ‚Üî EUR</div>
            <div class="badge">–§–∏–∫—Å–∏—Ä–∞–Ω –∫—É—Ä—Å</div>
          </div>
          <div class="body">
            <div class="row">
              <label>
                –°—É–º–∞ (–ª–≤.)
                <input id="fx_bgn" inputmode="decimal" placeholder="–Ω–∞–ø—Ä. 100.00" />
              </label>
              <label>
                –°—É–º–∞ (‚Ç¨)
                <input id="fx_eur" inputmode="decimal" placeholder="–Ω–∞–ø—Ä. 51.13" />
              </label>
            </div>

            <div class="row" style="margin-top:12px;">
              <label>
                –ö—É—Ä—Å (–ª–≤. –∑–∞ 1 ‚Ç¨)
                <input id="fx_rate" inputmode="decimal" value="1.95583" />
              </label>
              <div class="help">
                –í –ë—ä–ª–≥–∞—Ä–∏—è –∫—É—Ä—Å—ä—Ç –µ —Ñ–∏–∫—Å–∏—Ä–∞–Ω: 1 ‚Ç¨ = 1.95583 –ª–≤.  
                –ú–æ–∂–µ—à –¥–∞ –≥–æ –ø—Ä–æ–º–µ–Ω—è—à –≤—Ä–µ–º–µ–Ω–Ω–æ, –∞–∫–æ –∏—Å–∫–∞—à –≤—ä—Ç—Ä–µ—à–µ–Ω –∫—É—Ä—Å.
              </div>
            </div>

            <div class="controls">
              <div class="btn ghost" id="fx_clear">üßπ –ò–∑—á–∏—Å—Ç–∏</div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="head">
            <div class="h">‚ÑπÔ∏è –ü–æ–¥—Å–∫–∞–∑–∫–∞</div>
            <div class="badge">2 –∑–Ω–∞–∫–∞</div>
          </div>
          <div class="body">
            <div class="help">
              –ü–∏—à–∏ –≤ –µ–¥–Ω–æ—Ç–æ –ø–æ–ª–µ ‚Üí –¥—Ä—É–≥–æ—Ç–æ —Å–µ —Å–º—è—Ç–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ.  
              –ó–∞–∫—Ä—ä–≥–ª—è–º–µ –≤–∏–Ω–∞–≥–∏ –¥–æ 2 –∑–Ω–∞–∫–∞.
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ===================== CHANGE ===================== -->
    <section id="tab-change" class="section">
      <div class="grid">
        <div class="card">
          <div class="head">
            <div class="h">ü™ô –†–µ—Å—Ç–æ (–ø–ª–∞—â–∞—à –≤ –µ–¥–Ω–∞ –≤–∞–ª—É—Ç–∞, –≤—Ä—ä—â–∞—à –≤ –¥—Ä—É–≥–∞)</div>
            <div class="badge">—è—Å–Ω–∏ —Ç–æ—Ç–∞–ª–∏</div>
          </div>
          <div class="body">

            <div class="row">
              <label>
                –¶–µ–Ω–∞ (–ª–≤.)
                <input id="c_price_bgn" inputmode="decimal" placeholder="–Ω–∞–ø—Ä. 19.99" />
              </label>
              <label>
                –¶–µ–Ω–∞ (‚Ç¨)
                <input id="c_price_eur" inputmode="decimal" placeholder="–Ω–∞–ø—Ä. 10.22" />
              </label>
            </div>

            <div class="row" style="margin-top:12px;">
              <label>
                –ü–ª–∞—Ç–µ–Ω–æ (–ª–≤.)
                <input id="c_paid_bgn" inputmode="decimal" placeholder="–Ω–∞–ø—Ä. 20.00" />
              </label>
              <label>
                –ü–ª–∞—Ç–µ–Ω–æ (‚Ç¨)
                <input id="c_paid_eur" inputmode="decimal" placeholder="–Ω–∞–ø—Ä. 20.00" />
              </label>
            </div>

            <div class="row" style="margin-top:12px;">
              <label>
                –ö—É—Ä—Å (–ª–≤. –∑–∞ 1 ‚Ç¨)
                <input id="c_rate" inputmode="decimal" value="1.95583" />
              </label>
              <label>
                –í—Ä—ä—â–∞–º–µ —Ä–µ—Å—Ç–æ –≤
                <select id="c_return_currency">
                  <option value="BGN">–õ–µ–≤–∞ (BGN)</option>
                  <option value="EUR">–ï–≤—Ä–æ (EUR)</option>
                </select>
              </label>
            </div>

            <div class="controls">
              <div class="btn ghost" id="c_clear">üßπ –ò–∑—á–∏—Å—Ç–∏</div>
            </div>

            <div class="hr"></div>

            <div class="results" style="margin-top:0;">
              <div class="kpi">
                <div class="k">
                  <div class="name">–û–±—â–æ (–ª–≤.)</div>
                  <div class="val" id="c_total_bgn">0.00 –ª–≤.</div>
                </div>
                <div class="sub">
                  <span class="pill">–û–±—â–æ (‚Ç¨): <span id="c_total_eur">0.00 ‚Ç¨</span></span>
                </div>
              </div>

              <div class="kpi">
                <div class="k">
                  <div class="name">–†–µ—Å—Ç–æ (–≤ –∏–∑–±—Ä–∞–Ω–∞—Ç–∞ –≤–∞–ª—É—Ç–∞)</div>
                  <div class="val" id="c_change_main">0.00</div>
                </div>
                <div class="sub">
                  <span class="pill">–†–µ—Å—Ç–æ (–ª–≤.): <span id="c_change_bgn">0.00 –ª–≤.</span></span>
                  <span class="pill">–†–µ—Å—Ç–æ (‚Ç¨): <span id="c_change_eur">0.00 ‚Ç¨</span></span>
                </div>
              </div>
            </div>

            <div class="warnbox" id="c_warn"></div>

          </div>
        </div>

        <div class="card">
          <div class="head">
            <div class="h">‚ÑπÔ∏è –ö–∞–∫ —Ä–∞–±–æ—Ç–∏</div>
            <div class="badge">—è—Å–Ω–æ</div>
          </div>
          <div class="body">
            <div class="help">
              –ú–æ–∂–µ—à –¥–∞ –∑–∞–¥–∞–¥–µ—à —Ü–µ–Ω–∞ –≤ –ª–≤. –∏–ª–∏ ‚Ç¨ (–∏–ª–∏ –∏ –¥–≤–µ—Ç–µ).  
              –ó–∞ –ø–ª–∞—â–∞–Ω–µ—Ç–æ —Å—ä—â–æ. –ö–∞–ª–∫—É–ª–∞—Ç–æ—Ä—ä—Ç –ø—Ä–µ–≤—Ä—ä—â–∞ –ø–æ –∫—É—Ä—Å–∞ –∏ –ø–æ–∫–∞–∑–≤–∞:
              <b>–û–±—â–æ –≤ –ª–≤/‚Ç¨</b> –∏ <b>—Ä–µ—Å—Ç–æ –≤ –ª–≤/‚Ç¨</b>, –ø–ª—é—Å ‚Äú–≤ –∏–∑–±—Ä–∞–Ω–∞—Ç–∞ –≤–∞–ª—É—Ç–∞‚Äù.
            </div>
          </div>
        </div>
      </div>
    </section>

    <div class="toast" id="toast">–ö–æ–ø–∏—Ä–∞–Ω–æ ‚úÖ</div>

  </div>

<script>
  // ---------- helpers ----------
  const $ = (id) => document.getElementById(id);

  function toNum(v){
    if (v === null || v === undefined) return 0;
    const s = String(v).replace(",", ".").replace(/[^\d.-]/g, "");
    const n = parseFloat(s);
    return Number.isFinite(n) ? n : 0;
  }
  function fmt2(n){
    const x = Number.isFinite(n) ? n : 0;
    return x.toLocaleString("bg-BG", {minimumFractionDigits:2, maximumFractionDigits:2});
  }
  function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

  function showToast(msg){
    const t = $("toast");
    t.textContent = msg || "–ö–æ–ø–∏—Ä–∞–Ω–æ ‚úÖ";
    t.style.display = "block";
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=> t.style.display="none", 1600);
  }

  // ---------- tabs ----------
  const tabs = document.querySelectorAll(".tab");
  const sections = {
    margin: $("tab-margin"),
    fx: $("tab-fx"),
    change: $("tab-change")
  };
  function activateTab(name){
    tabs.forEach(t => t.classList.toggle("active", t.dataset.tab === name));
    Object.entries(sections).forEach(([k, el]) => el.classList.toggle("active", k === name));
    // anchor support
    if (name === "margin") location.hash = "#margin";
    if (name === "fx") location.hash = "#fx";
    if (name === "change") location.hash = "#resto";
  }
  tabs.forEach(t => t.addEventListener("click", ()=> activateTab(t.dataset.tab)));

  // ---------- Margin module ----------
  const m = {
    cost: $("m_cost"),
    cons: $("m_cons"),
    vat: $("m_vat"),
    base: $("m_base"),

    margin: $("m_margin"),
    slider: $("m_slider"),
    quick: $("m_quick"),

    modeMargin: $("mode_target_margin"),
    modeProfit: $("mode_target_profit"),
    targetProfit: $("m_target_profit"),

    priceEx: $("m_price_ex"),
    priceInc: $("m_price_inc"),
    notes: $("m_notes"),

    btnRecalc: $("btn_recalc"),
    btnCopy: $("btn_copy"),

    warn: $("m_warn"),

    // results
    rRevenueEx: $("r_revenue_ex"),
    rVatPill: $("r_vatpill"),
    rProfit: $("r_profit"),
    rMarginPill: $("r_marginpill"),
    rCons: $("r_cons"),
    rBasePill: $("r_basepill"),
    rTotalEx: $("r_total_ex"),
    rTotalInc: $("r_total_inc"),

    // chart
    chart: $("m_chart"),
    legend: $("m_legend"),
  };

  // build quick buttons 5..50 step 5
  (function(){
    for(let p=5; p<=50; p+=5){
      const b = document.createElement("div");
      b.className = "qbtn";
      b.textContent = p + "%";
      b.dataset.p = String(p);
      b.addEventListener("click", ()=>{
        setMode("margin");
        setMarginPct(p);
        setActiveQuick(p);
        recalcFrom("margin");
      });
      m.quick.appendChild(b);
    }
  })();
  function setActiveQuick(p){
    const btns = m.quick.querySelectorAll(".qbtn");
    btns.forEach(x => x.classList.toggle("active", Number(x.dataset.p) === Number(p)));
  }

  let mode = "margin"; // "margin" or "profit"
  let lastEdited = null;
  function setMode(newMode){
    mode = newMode;
    m.modeMargin.classList.toggle("active", mode === "margin");
    m.modeProfit.classList.toggle("active", mode === "profit");
    m.targetProfit.disabled = (mode !== "profit");
    // visual hint
    if (mode !== "profit") m.targetProfit.value = m.targetProfit.value; // no-op
  }
  m.modeMargin.addEventListener("click", ()=> { setMode("margin"); recalcFrom("margin"); });
  m.modeProfit.addEventListener("click", ()=> { setMode("profit"); recalcFrom("profit"); });

  function setMarginPct(p){
    const v = clamp(Number(p) || 0, 0, 1000);
    m.margin.value = fmt2(v);
    m.slider.value = String(v);
  }

  function getVatRate(){
    return clamp(toNum(m.vat.value), 0, 1000) / 100;
  }

  function drawDonut({cost, consultants, profit}){
    const ctx = m.chart.getContext("2d");
    const W = m.chart.width, H = m.chart.height;
    ctx.clearRect(0,0,W,H);

    // handle negatives
    const pcost = Math.max(0, cost);
    const pcons = Math.max(0, consultants);
    const pprof = Math.max(0, profit);
    const total = pcost + pcons + pprof;

    // colors
    const slices = [
      {name:"–†–∞–∑—Ö–æ–¥ –¥–æ –Ω–∞—Å", val: pcost, color:"#7aa2ff"},
      {name:"–ö–æ–Ω—Å—É–ª—Ç–∞–Ω—Ç–∏", val: pcons, color:"#ffcc66"},
      {name:"–ü–µ—á–∞–ª–±–∞", val: pprof, color:"#35d07f"},
    ];

    // background ring
    const cx=W/2, cy=H/2;
    const r=92;
    const ring=22;

    ctx.beginPath();
    ctx.arc(cx,cy,r,0,Math.PI*2);
    ctx.strokeStyle="rgba(34,49,84,.55)";
    ctx.lineWidth=ring;
    ctx.stroke();

    if(total <= 0){
      // center text
      ctx.fillStyle="rgba(234,240,255,.9)";
      ctx.font="700 14px system-ui";
      ctx.textAlign="center";
      ctx.fillText("–ù—è–º–∞ –¥–∞–Ω–Ω–∏", cx, cy+5);
      renderLegend(slices, 0);
      return;
    }

    let a0 = -Math.PI/2;
    slices.forEach(s=>{
      const a = (s.val/total) * Math.PI*2;
      if(a <= 0) return;
      ctx.beginPath();
      ctx.arc(cx,cy,r,a0,a0+a);
      ctx.strokeStyle=s.color;
      ctx.lineWidth=ring;
      ctx.lineCap="round";
      ctx.stroke();
      a0 += a;
    });

    // center text
    ctx.fillStyle="rgba(234,240,255,.95)";
    ctx.font="800 20px system-ui";
    ctx.textAlign="center";
    ctx.fillText(fmt2(total), cx, cy-2);
    ctx.fillStyle="rgba(169,182,216,.95)";
    ctx.font="600 12px system-ui";
    ctx.fillText("—Ä–∞–∑–±–∏–≤–∫–∞ (–ª–≤.)", cx, cy+18);

    renderLegend(slices, total);
  }

  function renderLegend(slices, total){
    m.legend.innerHTML = "";
    slices.forEach(s=>{
      const pct = total>0 ? (s.val/total*100) : 0;
      const row = document.createElement("div");
      row.className="legrow";
      row.innerHTML = `
        <div style="display:flex; gap:10px; align-items:center;">
          <div class="dot" style="background:${s.color}"></div>
          <div class="legname">${s.name}</div>
        </div>
        <div class="legval">${fmt2(s.val)} –ª–≤. <span style="color:var(--muted); font-weight:600;">(${fmt2(pct)}%)</span></div>
      `;
      m.legend.appendChild(row);
    });
  }

  function updateWarning(companyProfit, consultants){
    const w = m.warn;
    w.style.display = "none";
    w.textContent = "";
    if(consultants > companyProfit && companyProfit > 0){
      w.style.display = "block";
      w.innerHTML = `‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ: ‚Äû–ö–æ–Ω—Å—É–ª—Ç–∞–Ω—Ç–∏‚Äú (${fmt2(consultants)} –ª–≤.) –Ω–∞–¥–≤–∏—à–∞–≤–∞—Ç –ø–µ—á–∞–ª–±–∞—Ç–∞ –∑–∞ —Ñ–∏—Ä–º–∞—Ç–∞ (${fmt2(companyProfit)} –ª–≤.).`;
    }
    if(companyProfit < 0){
      w.style.display = "block";
      w.innerHTML = `‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ: –ø–æ–ª—É—á–∞–≤–∞ —Å–µ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª–Ω–∞ –ø–µ—á–∞–ª–±–∞ –∑–∞ —Ñ–∏—Ä–º–∞—Ç–∞ (${fmt2(companyProfit)} –ª–≤.). –ü—Ä–æ–≤–µ—Ä–∏ —Ü–µ–Ω–∞—Ç–∞/—Ä–∞–∑—Ö–æ–¥–∏—Ç–µ.`;
    }
  }

  function recalcFrom(source){
    const cost = toNum(m.cost.value);
    const cons = toNum(m.cons.value);
    const base = cost + cons;
    m.base.value = fmt2(base);

    const vatR = getVatRate();

    let priceEx = toNum(m.priceEx.value);
    let priceInc = toNum(m.priceInc.value);

    // Determine main driver
    // Priority: explicit price fields (if edited) > mode driver
    if(source === "price_ex"){
      priceEx = toNum(m.priceEx.value);
      priceInc = priceEx * (1 + vatR);
    } else if(source === "price_inc"){
      priceInc = toNum(m.priceInc.value);
      priceEx = (1 + vatR) > 0 ? (priceInc / (1 + vatR)) : 0;
    } else if(source === "profit" && mode === "profit"){
      const targetProfit = Math.max(0, toNum(m.targetProfit.value));
      priceEx = base + targetProfit;
      priceInc = priceEx * (1 + vatR);
    } else {
      // default driver: margin %
      const marginPct = clamp(toNum(m.margin.value), 0, 1000);
      // priceEx = base / (1 - margin)
      // where margin = profit/revenue => profit = revenue*margin; base = revenue - profit = revenue*(1 - margin)
      const margin = marginPct/100;
      if(margin >= 0.999999){ // avoid div by near-zero
        priceEx = 0;
      } else {
        priceEx = base / (1 - margin);
      }
      priceInc = priceEx * (1 + vatR);
    }

    // Compute profit & margin from priceEx
    const profit = priceEx - base;
    const marginPctImplied = priceEx > 0 ? (profit / priceEx * 100) : 0;
    const vatAmount = priceEx * vatR;

    // Update fields (keep 2 decimals)
    m.priceEx.value = fmt2(priceEx);
    m.priceInc.value = fmt2(priceInc);

    // Update implied margin slider/field always from implied
    // (even when price drives calculation)
    m.slider.value = String(clamp(marginPctImplied, 0, 1000));
    m.margin.value = fmt2(clamp(marginPctImplied, 0, 1000));

    // results
    m.rRevenueEx.textContent = fmt2(priceEx) + " –ª–≤.";
    m.rVatPill.textContent = "–î–î–°: " + fmt2(vatAmount) + " –ª–≤.";
    m.rProfit.textContent = fmt2(profit) + " –ª–≤.";
    m.rMarginPill.textContent = "–ú–∞—Ä–∂: " + fmt2(marginPctImplied) + "%";
    m.rCons.textContent = fmt2(cons) + " –ª–≤.";
    m.rBasePill.textContent = "–ë–∞–∑–∞: " + fmt2(base) + " –ª–≤.";
    m.rTotalEx.textContent = fmt2(priceEx) + " –ª–≤.";
    m.rTotalInc.textContent = fmt2(priceInc) + " –ª–≤.";

    // warnings
    updateWarning(profit, cons);

    // chart
    drawDonut({cost, consultants: cons, profit});

    // quick buttons active state (only if exact match)
    setActiveQuick(null);
    const impliedRound = Math.round(marginPctImplied*100)/100;
    m.quick.querySelectorAll(".qbtn").forEach(b=>{
      const p = Number(b.dataset.p);
      b.classList.toggle("active", Math.abs(impliedRound - p) < 0.001);
    });
  }

  // Events
  m.cost.addEventListener("input", ()=> recalcFrom(mode==="profit" ? "profit" : "margin"));
  m.cons.addEventListener("input", ()=> recalcFrom(mode==="profit" ? "profit" : "margin"));
  m.vat.addEventListener("input", ()=> recalcFrom("price_ex")); // keep price ex stable by default

  m.margin.addEventListener("input", ()=>{
    setMode("margin");
    const v = clamp(toNum(m.margin.value), 0, 1000);
    m.slider.value = String(v);
    recalcFrom("margin");
  });

  m.slider.addEventListener("input", ()=>{
    setMode("margin");
    const v = clamp(toNum(m.slider.value), 0, 1000);
    m.margin.value = fmt2(v);
    recalcFrom("margin");
  });

  m.targetProfit.addEventListener("input", ()=>{
    setMode("profit");
    recalcFrom("profit");
  });

  m.priceEx.addEventListener("input", ()=>{
    recalcFrom("price_ex");
  });
  m.priceInc.addEventListener("input", ()=>{
    recalcFrom("price_inc");
  });

  m.btnRecalc.addEventListener("click", ()=> recalcFrom(mode==="profit" ? "profit" : "margin"));

  m.btnCopy.addEventListener("click", async ()=>{
    const cost = toNum(m.cost.value);
    const cons = toNum(m.cons.value);
    const base = cost + cons;
    const vatR = getVatRate();
    const priceEx = toNum(m.priceEx.value);
    const priceInc = toNum(m.priceInc.value);
    const profit = priceEx - base;
    const marginPct = priceEx > 0 ? (profit/priceEx*100) : 0;
    const vatAmount = priceEx * vatR;

    const warn = (cons > profit && profit > 0) ? "‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ: –ö–æ–Ω—Å—É–ª—Ç–∞–Ω—Ç–∏ > –ü–µ—á–∞–ª–±–∞ –∑–∞ —Ñ–∏—Ä–º–∞—Ç–∞.\n" : "";
    const notes = (m.notes.value || "").trim();

    const text =
`üßæ –û—Ñ–µ—Ä—Ç–∞ (–∫–∞–ª–∫—É–ª–∞—Ü–∏—è)
–¶–µ–Ω–∞ –±–µ–∑ –î–î–°: ${fmt2(priceEx)} –ª–≤.
–î–î–° (${fmt2(vatR*100)}%): ${fmt2(vatAmount)} –ª–≤.
–¶–µ–Ω–∞ —Å –î–î–°: ${fmt2(priceInc)} –ª–≤.

–ú–∞—Ä–∂ (–∫–ª–∞—Å–∏—á–µ—Å–∫–∏): ${fmt2(marginPct)}%
–ü–µ—á–∞–ª–±–∞ –∑–∞ —Ñ–∏—Ä–º–∞—Ç–∞: ${fmt2(profit)} –ª–≤.
–ö–æ–Ω—Å—É–ª—Ç–∞–Ω—Ç–∏ (FOC): ${fmt2(cons)} –ª–≤.
–ë–∞–∑–∞ (–†–∞–∑—Ö–æ–¥ + –ö–æ–Ω—Å—É–ª—Ç–∞–Ω—Ç–∏): ${fmt2(base)} –ª–≤.

${warn}${notes ? ("–ó–∞–±–µ–ª–µ–∂–∫–∏: " + notes) : ""}`.trim();

    try{
      await navigator.clipboard.writeText(text);
      showToast("–ö–æ–ø–∏—Ä–∞–Ω–æ ‚úÖ");
    }catch(e){
      // fallback
      const ta = document.createElement("textarea");
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      ta.remove();
      showToast("–ö–æ–ø–∏—Ä–∞–Ω–æ ‚úÖ");
    }
  });

  // init margin defaults
  setMode("margin");
  setMarginPct(20);
  recalcFrom("margin");

  // hash open
  (function(){
    const h = (location.hash || "").toLowerCase();
    if(h.includes("fx")) activateTab("fx");
    else if(h.includes("resto") || h.includes("change")) activateTab("change");
    else activateTab("margin");
  })();

  // ---------- FX module ----------
  const fx = {
    bgn: $("fx_bgn"),
    eur: $("fx_eur"),
    rate: $("fx_rate"),
    clear: $("fx_clear"),
    lock: null
  };
  function fxRecalc(source){
    const rate = toNum(fx.rate.value) || 1.95583;
    if(source === "bgn"){
      const b = toNum(fx.bgn.value);
      fx.eur.value = fmt2(b / rate);
    } else if(source === "eur"){
      const e = toNum(fx.eur.value);
      fx.bgn.value = fmt2(e * rate);
    } else {
      // default keep bgn and compute eur
      const b = toNum(fx.bgn.value);
      fx.eur.value = fmt2(b / rate);
    }
  }
  fx.bgn.addEventListener("input", ()=> fxRecalc("bgn"));
  fx.eur.addEventListener("input", ()=> fxRecalc("eur"));
  fx.rate.addEventListener("input", ()=> fxRecalc("bgn"));
  fx.clear.addEventListener("click", ()=>{
    fx.bgn.value = "";
    fx.eur.value = "";
    fx.rate.value = "1.95583";
  });

  // ---------- Change module ----------
  const c = {
    priceBGN: $("c_price_bgn"),
    priceEUR: $("c_price_eur"),
    paidBGN: $("c_paid_bgn"),
    paidEUR: $("c_paid_eur"),
    rate: $("c_rate"),
    ret: $("c_return_currency"),
    totalBGN: $("c_total_bgn"),
    totalEUR: $("c_total_eur"),
    changeMain: $("c_change_main"),
    changeBGN: $("c_change_bgn"),
    changeEUR: $("c_change_eur"),
    warn: $("c_warn"),
    clear: $("c_clear")
  };

  function changeRecalc(){
    const rate = toNum(c.rate.value) || 1.95583;

    // Determine price in BGN (if user fills EUR only -> convert)
    const price_bgn = toNum(c.priceBGN.value);
    const price_eur = toNum(c.priceEUR.value);

    let totalBGN = 0;
    if(price_bgn > 0) totalBGN = price_bgn;
    else if(price_eur > 0) totalBGN = price_eur * rate;
    else totalBGN = 0;

    const totalEUR = rate > 0 ? (totalBGN / rate) : 0;

    // Determine paid in BGN (if paid in EUR only -> convert)
    const paid_bgn = toNum(c.paidBGN.value);
    const paid_eur = toNum(c.paidEUR.value);

    let paidBGN = 0;
    if(paid_bgn > 0) paidBGN = paid_bgn;
    else if(paid_eur > 0) paidBGN = paid_eur * rate;
    else paidBGN = 0;

    const changeBGN = paidBGN - totalBGN;
    const changeEUR = rate > 0 ? (changeBGN / rate) : 0;

    c.totalBGN.textContent = fmt2(totalBGN) + " –ª–≤.";
    c.totalEUR.textContent = fmt2(totalEUR) + " ‚Ç¨";

    const main = (c.ret.value === "EUR") ? (fmt2(changeEUR) + " ‚Ç¨") : (fmt2(changeBGN) + " –ª–≤.");
    c.changeMain.textContent = main;

    c.changeBGN.textContent = fmt2(changeBGN) + " –ª–≤.";
    c.changeEUR.textContent = fmt2(changeEUR) + " ‚Ç¨";

    c.warn.style.display = "none";
    c.warn.textContent = "";
    if(changeBGN < -0.00001){
      c.warn.style.display = "block";
      c.warn.textContent = "‚ö†Ô∏è –ü–ª–∞—Ç–µ–Ω–∞—Ç–∞ —Å—É–º–∞ –µ –ø–æ-–º–∞–ª–∫–∞ –æ—Ç —Ü–µ–Ω–∞—Ç–∞ (–Ω–µ–¥–æ—Å—Ç–∞—Ç—ä—á–Ω–æ –ø–ª–∞—â–∞–Ω–µ).";
    }
  }

  [c.priceBGN, c.priceEUR, c.paidBGN, c.paidEUR, c.rate, c.ret].forEach(el => el.addEventListener("input", changeRecalc));
  c.clear.addEventListener("click", ()=>{
    c.priceBGN.value="";
    c.priceEUR.value="";
    c.paidBGN.value="";
    c.paidEUR.value="";
    c.rate.value="1.95583";
    c.ret.value="BGN";
    changeRecalc();
  });
  changeRecalc();
</script>
</body>
</html>
